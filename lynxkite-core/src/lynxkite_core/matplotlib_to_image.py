"""A wrapper for functions that use Matplotlib to instead return an image as a data: URL."""

from __future__ import annotations

import functools
import base64
import io

# From https://registry.color.org/rgb-registry/displayp3.
P3_ICC_PROFILE = b"\x00\x00\x02\x18appl\x04\x00\x00\x00mntrRGB XYZ \x07\xe6\x00\x01\x00\x01\x00\x00\x00\x00\x00\x00acspAPPL\x00\x00\x00\x00APPL\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf6\xd6\x00\x01\x00\x00\x00\x00\xd3-appl\xec\xfd\xa3\x8e8\x85G\xc3m\xb4\xbdOz\xda\x18/\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\ndesc\x00\x00\x00\xfc\x00\x00\x000cprt\x00\x00\x01,\x00\x00\x00Pwtpt\x00\x00\x01|\x00\x00\x00\x14rXYZ\x00\x00\x01\x90\x00\x00\x00\x14gXYZ\x00\x00\x01\xa4\x00\x00\x00\x14bXYZ\x00\x00\x01\xb8\x00\x00\x00\x14rTRC\x00\x00\x01\xcc\x00\x00\x00 chad\x00\x00\x01\xec\x00\x00\x00,bTRC\x00\x00\x01\xcc\x00\x00\x00 gTRC\x00\x00\x01\xcc\x00\x00\x00 mluc\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x0cenUS\x00\x00\x00\x14\x00\x00\x00\x1c\x00D\x00i\x00s\x00p\x00l\x00a\x00y\x00 \x00P\x003mluc\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x0cenUS\x00\x00\x004\x00\x00\x00\x1c\x00C\x00o\x00p\x00y\x00r\x00i\x00g\x00h\x00t\x00 \x00A\x00p\x00p\x00l\x00e\x00 \x00I\x00n\x00c\x00.\x00,\x00 \x002\x000\x002\x002XYZ \x00\x00\x00\x00\x00\x00\xf6\xd5\x00\x01\x00\x00\x00\x00\xd3,XYZ \x00\x00\x00\x00\x00\x00\x83\xdf\x00\x00=\xbf\xff\xff\xff\xbbXYZ \x00\x00\x00\x00\x00\x00J\xbf\x00\x00\xb17\x00\x00\n\xb9XYZ \x00\x00\x00\x00\x00\x00(8\x00\x00\x11\x0b\x00\x00\xc8\xb9para\x00\x00\x00\x00\x00\x03\x00\x00\x00\x02ff\x00\x00\xf2\xa7\x00\x00\rY\x00\x00\x13\xd0\x00\x00\n[sf32\x00\x00\x00\x00\x00\x01\x0cB\x00\x00\x05\xde\xff\xff\xf3&\x00\x00\x07\x93\x00\x00\xfd\x90\xff\xff\xfb\xa2\xff\xff\xfd\xa3\x00\x00\x03\xdc\x00\x00\xc0n"


def img_to_data_url(buf: io.BytesIO) -> str:
    try:
        from PIL import Image
    except ImportError:
        import warnings

        warnings.warn(
            "Pillow not installed. Install Pillow to reduce network transfer size for plots."
        )
        image_base64 = base64.b64encode(buf.read()).decode("utf-8")
        return f"data:image/png;base64,{image_base64}"

    # Load PNG with Pillow and save as WebP with P3 ICC profile.
    # This blows up the colors — reds become redder, blues bluer. Makes the plots look better!
    img = Image.open(buf)
    webp_buf = io.BytesIO()
    img.save(webp_buf, format="webp", quality=50, icc_profile=P3_ICC_PROFILE)
    webp_buf.seek(0)
    image_base64 = base64.b64encode(webp_buf.read()).decode("utf-8")
    return f"data:image/webp;base64,{image_base64}"


def matplotlib_to_image(func):
    """Decorator for converting a Matplotlib figure to an image."""
    # Lazy import so the module can be imported even if Matplotlib isn't installed.
    import matplotlib.pyplot as plt
    import matplotlib

    # Make sure we use the non-interactive backend.
    matplotlib.use("agg")

    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        func(*args, **kwargs)
        buf = io.BytesIO()
        plt.savefig(buf, format="png", dpi=300)
        plt.close()
        buf.seek(0)
        return img_to_data_url(buf)

    return wrapper
